---
format_version: 1.1.0
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  - PROJECT_TITLE: Walls
    opts:
      is_expand: true
  - XCODE_PROJECT_PATH: "./${PROJECT_TITLE}.xcodeproj"
    opts:
      is_expand: true
  - XCODE_PROJECT_SCHEME: "${PROJECT_TITLE}"
    opts:
      is_expand: true
  - XCODE_PLIST_FOLDER: "./${PROJECT_TITLE}"
    opts:
      is_expand: true
  - BITRISE_YML_PATH: "./bitrise.yml"
    opts:
      is_expand: false
      
trigger_map:
- pattern: development
  is_pull_request_allowed: false
  workflow: master
- pattern: master
  is_pull_request_allowed: false
  workflow: master
  
workflows:
  download_bitrise_yml:
    steps:
    - script:
        title: Downloading bitrise.yml ...
        inputs:
        - content: |-
            #!/bin/bash
            set -e
            ret_content=$(curl --fail https://www.bitrise.io/api/app/${BITRISE_APP_SLUG}/config/download.yml?api_token=${BITRISE_APP_API_TOKEN})
            echo "${ret_content}" > ${BITRISE_YML_PATH}
  upload_bitrise_yml:
    steps:
    - script:
        title: Uploading bitrise.yml ...
        inputs:
        - content: |-
            #!/bin/bash
            curl --fail -X POST --data-urlencode "app_config_datastore_yaml=$(cat ${BITRISE_YML_PATH})" https://www.bitrise.io/api/app/${BITRISE_APP_SLUG}/config/upload.yml?api_token=${BITRISE_APP_API_TOKEN}
  _cloning:
    description: This is a utility workflow, used by other workflows.
    steps:
    - git-clone@3.1.1: {}
    - ensure-clean-git@0.9.1: {}
    - script:
        title: Checking bitrise.yml file
        inputs:
        - content: |-
            #!/bin/bash
            
            test -e bitrise.yml
  _retreive_build_number:
    description: This is a utility workflow, used by other workflows.
    steps:
    - script:
        title: Retreiving buildnumber
        inputs:
        - content: |-
            #!/bin/bash
            
            #buildNumber=`curl --user build:"E$^VM8476C(XW>Kb6f;b" "http://toolsss.neopixl.com/buildnumber/nextBuildNumber.php?project=${PROJECT_TITLE}"`
            buildNumber=4
            if [ -z "$buildNumber" ]; then
                echo "You are not connected to internet or tools.neopixl.com not available."
                exit 1
            fi
            envman add --key NEW_BUILD_NUMBER --value $buildNumber
            exit 0
  
  _build_number_ios:
    description: This is a utility workflow, used by other workflows.
    before_run:
    - _retreive_build_number
    steps:
    - script:
        title: Changing buildnumber
        inputs:
        - content: |-
            #!/bin/bash
            
            for i in `find $XCODE_PLIST_FOLDER -name '*.plist'` ;do
                /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $NEW_BUILD_NUMBER" "$i"
            done
            exit 0
  _build_number_android:
    description: This is a utility workflow, used by other workflows.
    before_run:
    - _retreive_build_number
    steps:
    - script:
        title: Changing buildnumber
        inputs:
        - content: |-
            #!/bin/bash
            
            buildNumber=`curl --user build:"E$^VM8476C(XW>Kb6f;b" "http://toolsss.neopixl.com/buildnumber/nextBuildNumber.php?project=Walls"`
            if [ -z "$buildNumber" ]; then
                echo "You are not connected to internet or tools.neopixl.com not available."
                exit 1
            fi
  master:
    description: |-
      This workflow will run for the master branch
    before_run:
    - _cloning
    - _build_number_ios
    steps:
    - xcode-archive:
        title: Run Xcode archive
        inputs:
        - project_path: "${XCODE_PROJECT_PATH}"
        - scheme: "${XCODE_PROJECT_SCHEME}"
